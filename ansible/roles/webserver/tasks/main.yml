- name: "docker | Launch postgres container"
  docker_container:
    name: pgdb
    image: postgres:11.2
    ports:
      - '5432:5432'
    env:
      POSTGRES_USER: ctfd
      POSTGRES_PASSWORD: "{{ postgres_db_password }}"
    volumes:
      - /var/lib/postgresql
    networks:
      - name: ctfdnet

- name: docker | Build web container image
  docker_image:
    path: ../ctfd
    name: web
    force: "{{ docker_force }}"

- name: docker | Start web container
  docker_container:
    name: web
    image: web
    ports:
      - '8000:8000'
    env:
      DATABASE_URL: 'postgresql+psycopg2://ctfd:{{ postgres_db_password }}@pgdb:5432/ctfd'
      VIRTUAL_HOST: '{{ ctf_virtual_host }}'
    volumes:
      - '{{ ctf_log_dir }}:/opt/CTFd/logs'
    networks:
      - name: ctfdnet
